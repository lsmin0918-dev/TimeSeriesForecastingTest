import json
import os

# Updated Simulation Code with Aggressive Strategy
CODE_SIM_AGGRESSIVE = [
    "# ì˜ˆì¸¡ í•¨ìˆ˜\n",
    "def predict_with_prob(model, loader):\n",
    "    model.eval()\n",
    "    probs = []\n",
    "    with torch.no_grad():\n",
    "        for batch_X, _ in loader:\n",
    "            batch_X = batch_X.to(device)\n",
    "            out = model(batch_X)\n",
    "            probs.append(out.cpu().numpy())\n",
    "    return np.vstack(probs).flatten()\n",
    "\n",
    "# í…ŒìŠ¤íŠ¸ ì…‹ ì˜ˆì¸¡ ìˆ˜í–‰\n",
    "my_prob = predict_with_prob(my_model, test_loader)\n",
    "\n",
    "# ì‹œë®¬ë ˆì´ì…˜ìš© ë°ì´í„° ì¤€ë¹„\n",
    "test_start_idx = len(btc_features) - len(y_test) + sequence_length\n",
    "test_prices = btc_features['Close'].iloc[test_start_idx:test_start_idx+len(my_prob)].values\n",
    "test_dates = btc_features.index[test_start_idx:test_start_idx+len(my_prob)]\n",
    "\n",
    "# ë³´ì¡° ì§€í‘œ ì¤€ë¹„ (RSI, MACD)\n",
    "test_rsi = btc_features['RSI_14'].iloc[test_start_idx:test_start_idx+len(my_prob)].values\n",
    "test_macd = btc_features['MACD'].iloc[test_start_idx:test_start_idx+len(my_prob)].values\n",
    "test_macd_sig = btc_features['MACD_Signal'].iloc[test_start_idx:test_start_idx+len(my_prob)].values\n",
    "\n",
    "# ë³€ë™ì„± ë°ì´í„°\n",
    "test_volatility = btc_features['Volatility_10'].iloc[test_start_idx:test_start_idx+len(my_prob)].values\n",
    "volatility_threshold = np.percentile(test_volatility, 90) # ìƒìœ„ 10%ë§Œ í”¼í•¨ (ê³µê²©ì )\n",
    "\n",
    "# ê³µê²©ì  í•˜ì´ë¸Œë¦¬ë“œ ì „ëµ ì‹œë®¬ë ˆì´ì…˜\n",
    "def simulate_custom_strategy(probs, prices, dates, rsi, macd, macd_sig, volatilities, vol_thresh, initial_capital=10000):\n",
    "    cash = initial_capital\n",
    "    btc = 0\n",
    "    tx_fee = 0.001\n",
    "    history = []\n",
    "    trade_log = []\n",
    "    \n",
    "    # íŒŒë¼ë¯¸í„° : ê±°ë˜ í™œì„±í™”ë¥¼ ìœ„í•´ ì„ê³„ê°’ ëŒ€í­ ë‚®ì¶¤\n",
    "    BUY_THRESH = 0.50    # 50% ì´ìƒì´ë©´ ë§¤ìˆ˜ ê²€í† \n",
    "    SELL_THRESH = 0.40   # 40% ë¯¸ë§Œì´ë©´ ë§¤ë„ ê²€í† \n",
    "    \n",
    "    for i in range(len(probs)):\n",
    "        prob = probs[i]\n",
    "        price = prices[i]\n",
    "        vol = volatilities[i]\n",
    "        r_val = rsi[i]\n",
    "        m_val = macd[i]\n",
    "        m_sig = macd_sig[i]\n",
    "        \n",
    "        portfolio_val = cash + btc * price\n",
    "        \n",
    "        # ë§ˆì§€ë§‰ ë‚  ì „ëŸ‰ ë§¤ë„\n",
    "        if i == len(probs) - 1:\n",
    "            if btc > 0:\n",
    "                cash += btc * price * (1 - tx_fee)\n",
    "                btc = 0\n",
    "            history.append(cash)\n",
    "            continue\n",
    "            \n",
    "        # 1. ê¸°ë³¸ íƒ€ê²Ÿ ë¹„ì¤‘ ê³„ì‚° (í™•ë¥  ê¸°ë°˜)\n",
    "        # (Prob - 0.4) * 2 => 0.4ì¼ë•Œ 0, 0.9ì¼ë•Œ 1.0\n",
    "        raw_ratio = (prob - 0.4) * 2.0\n",
    "        target_ratio = min(max(raw_ratio, 0.0), 1.0)\n",
    "        \n",
    "        # 2. ë³´ì¡° ì§€í‘œ ë³´ì • (RSI & MACD)\n",
    "        # RSI < 30 (ê³¼ë§¤ë„) -> ê°•ì œ ë§¤ìˆ˜ ì‹ í˜¸ (ë¹„ì¤‘ +0.3)\n",
    "        if r_val < 30:\n",
    "            target_ratio = max(target_ratio, 0.3)\n",
    "            target_ratio += 0.2\n",
    "            \n",
    "        # RSI > 70 (ê³¼ë§¤ìˆ˜) -> ë¹„ì¤‘ ì¶•ì†Œ\n",
    "        if r_val > 70:\n",
    "            target_ratio *= 0.5\n",
    "            \n",
    "        # MACD ê³¨ë“ í¬ë¡œìŠ¤ ìƒíƒœ (MACD > Signal) -> ë¹„ì¤‘ í™•ëŒ€\n",
    "        if m_val > m_sig:\n",
    "            target_ratio *= 1.2\n",
    "            # ìµœì†Œ 10%ëŠ” ê°€ì ¸ê°€ë„ë¡\n",
    "            if target_ratio < 0.1: target_ratio = 0.1\n",
    "        else:\n",
    "            # ë°ë“œí¬ë¡œìŠ¤ -> ë¹„ì¤‘ ì¶•ì†Œ\n",
    "            target_ratio *= 0.8\n",
    "            \n",
    "        # 3. ë¦¬ìŠ¤í¬ ê´€ë¦¬ (ì´ˆê³ ë³€ë™ì„±ë§Œ íšŒí”¼)\n",
    "        if vol > vol_thresh:\n",
    "            target_ratio *= 0.5\n",
    "            \n",
    "        # ìµœì¢… ë¹„ì¤‘ í´ë¦¬í•‘ 0~1\n",
    "        target_ratio = min(max(target_ratio, 0.0), 1.0)\n",
    "            \n",
    "        # 4. ë¦¬ë°¸ëŸ°ì‹±\n",
    "        target_btc_val = portfolio_val * target_ratio\n",
    "        current_btc_val = btc * price\n",
    "        diff = target_btc_val - current_btc_val\n",
    "        \n",
    "        # ê±°ë˜ ì‹¤í–‰\n",
    "        if diff > 0: # ë§¤ìˆ˜\n",
    "            # 10ë‹¬ëŸ¬ ì´ìƒì¼ ë•Œë§Œ ê±°ë˜\n",
    "            if diff > 10:\n",
    "                amount_to_buy_usd = diff\n",
    "                if amount_to_buy_usd > cash: amount_to_buy_usd = cash\n",
    "                if amount_to_buy_usd > 0:\n",
    "                    btc_bought = (amount_to_buy_usd * (1 - tx_fee)) / price\n",
    "                    btc += btc_bought\n",
    "                    cash -= amount_to_buy_usd\n",
    "                    trade_log.append({'date': dates[i], 'action': 'BUY', 'price': price, 'value': amount_to_buy_usd})\n",
    "        elif diff < 0: # ë§¤ë„\n",
    "            if -diff > 10:\n",
    "                amount_to_sell_usd = -diff\n",
    "                amount_to_sell_btc = amount_to_sell_usd / price\n",
    "                if amount_to_sell_btc > btc: amount_to_sell_btc = btc\n",
    "                if amount_to_sell_btc > 0:\n",
    "                    cash_gained = amount_to_sell_btc * price * (1 - tx_fee)\n",
    "                    cash += cash_gained\n",
    "                    btc -= amount_to_sell_btc\n",
    "                    trade_log.append({'date': dates[i], 'action': 'SELL', 'price': price, 'value': cash_gained})\n",
    "            \n",
    "        history.append(cash + btc * price)\n",
    "\n",
    "    total_return = (history[-1] - initial_capital) / initial_capital * 100\n",
    "    \n",
    "    return {\n",
    "        'initial_capital': initial_capital,\n",
    "        'final_value': history[-1],\n",
    "        'total_return': total_return,\n",
    "        'portfolio_values': history,\n",
    "        'num_trades': len(trade_log),\n",
    "        'total_fees_paid': 0 # Simplified\n",
    "    }\n",
    "\n",
    "# ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰\n",
    "my_result = simulate_custom_strategy(\n",
    "    probs=my_prob,\n",
    "    prices=test_prices,\n",
    "    dates=test_dates,\n",
    "    rsi=test_rsi,\n",
    "    macd=test_macd,\n",
    "    macd_sig=test_macd_sig,\n",
    "    volatilities=test_volatility,\n",
    "    vol_thresh=volatility_threshold\n",
    ")\n",
    "\n",
    "print(\"=\"*70)\n",
    "print(\"ğŸš€ ë‚˜ì˜ íŠ¸ë ˆì´ë”© ì „ëµ ê²°ê³¼ (Aggressive Hybrid)\")\n",
    "print(\"=\"*70)\n",
    "print(f\"ì´ˆê¸° ìë³¸: ${my_result['initial_capital']:,.2f}\")\n",
    "print(f\"ìµœì¢… ìë³¸: ${my_result['final_value']:,.2f}\")\n",
    "print(f\"ìˆ˜ìµë¥ : {my_result['total_return']:.2f}%\")\n",
    "print(f\"ê±°ë˜ íšŸìˆ˜: {my_result['num_trades']}íšŒ\")\n",
    "print(\"=\"*70)"
]

# Updated Design Description to match Aggressive Strategy
DESIGN_DESC_AGGRESSIVE = [
    "## 5. ìì‹ ë§Œì˜ ëª¨ë¸ ë° ì „ëµ ê°œë°œ â­\n",
    "\n",
    "### ğŸ“ ê°œë°œ ê°€ì´ë“œ\n",
    "\n",
    "#### 1. ëª¨ë¸ ê°œì„  ì•„ì´ë””ì–´\n",
    "- **ì•„í‚¤í…ì²˜**: LSTM â†’ GRU, Transformer, CNN+LSTM, Attention\n",
    "- **í•˜ì´í¼íŒŒë¼ë¯¸í„°**: hidden_size, dropout, learning_rate\n",
    "- **ì•™ìƒë¸”**: ì—¬ëŸ¬ ëª¨ë¸ì˜ ì˜ˆì¸¡ ê²°í•©\n",
    "\n",
    "#### 2. ì „ëµ ê°œì„  ì•„ì´ë””ì–´\n",
    "- **ì„ê³„ê°’ ì¡°ì •**: thresholdë¥¼ 0.6 ë˜ëŠ” 0.7ë¡œ ë†’ì—¬ ì‹ ë¢°ë„ ë†’ì€ ê±°ë˜ë§Œ\n",
    "- **í¬ì§€ì…˜ í¬ê¸°**: í™•ë¥  Ã— 2 - 1 (ì˜ˆ: 70% â†’ 40% íˆ¬ì)\n",
    "- **ë¦¬ìŠ¤í¬ ê´€ë¦¬**: ìµœëŒ€ ì†ì‹¤ í•œë„, ì´ë™í‰ê· ì„  í™œìš©\n",
    "- **ë³µí•© ì „ëµ**: ëª¨ë¸ ì˜ˆì¸¡ + RSI + MACD ê²°í•©\n",
    "\n",
    "---\n",
    "\n",
    "**TODO: ì•„ë˜ì— ìì‹ ì˜ ëª¨ë¸ ì„¤ê³„ ì„¤ëª…ì„ ì‘ì„±í•˜ì„¸ìš”**\n",
    "\n",
    "```\n",
    "1. ëª¨ë¸ ì•„í‚¤í…ì²˜: **RobustGRU**\n",
    "   - 2ì¸µ GRU êµ¬ì¡° (Hidden Size: 128 -> 64)\n",
    "   - ëª¨ë¸ ê°•ê±´ì„± í™•ë³´ë¥¼ ìœ„í•´ Dropout(0.3) ë° Batch Normalization ì ìš©\n",
    "\n",
    "2. ì„ íƒ ì´ìœ :\n",
    "   - GRUëŠ” LSTM ëŒ€ë¹„ í•™ìŠµì´ ë¹ ë¥´ê³  ë°ì´í„°ê°€ ì ì€ ê¸ˆìœµ ì‹œê³„ì—´ì— ì í•©\n",
    "   - ë‹¨ìˆœ ë²¤ì¹˜ë§ˆí¬ ëª¨ë¸ë³´ë‹¤ ë³µì¡í•œ íŒ¨í„´ì„ í•™ìŠµí•  ìˆ˜ ìˆë„ë¡ ë ˆì´ì–´ ê¹Šì´ë¥¼ ëŠ˜ë¦¼\n",
    "\n",
    "3. íŠ¸ë ˆì´ë”© ì „ëµ: **Aggressive Hybrid (Model + RSI + MACD)**\n",
    "   - **í•µì‹¬ ì•„ì´ë””ì–´**: í•˜ë½ì¥ì—ì„œë„ ê¸°ìˆ ì  ë°˜ë“±(Rebound)ì„ ë…¸ë¦¬ê¸° ìœ„í•´ ê¸°ìˆ ì  ì§€í‘œë¥¼ ì ê·¹ í™œìš©\n",
    "   - **1. ëª¨ë¸ í™•ì‹ ë„**: ë§¤ìˆ˜ ì„ê³„ê°’ì„ 0.5ë¡œ ëŒ€í­ ë‚®ì¶”ì–´ ê±°ë˜ ê¸°íšŒë¥¼ ëŠ˜ë¦¼\n",
    "   - **2. RSI ë³´ì •**: RSI 30 ë¯¸ë§Œ(ê³¼ë§¤ë„) êµ¬ê°„ì—ì„œëŠ” ëª¨ë¸ ì˜ˆì¸¡ì´ ë‚®ì•„ë„ ê°•ì œ ë§¤ìˆ˜ ì‹ í˜¸ ë°œìƒ (ì—­ì¶”ì„¸ ë§¤ë§¤)\n",
    "   - **3. MACD í•„í„°**: ê³¨ë“ í¬ë¡œìŠ¤(MACD > Signal) ìƒíƒœì¼ ë•Œ ë¹„ì¤‘ 20% í™•ëŒ€\n",
    "   - **4. ë¦¬ë°¸ëŸ°ì‹±**: í™•ë¥  ë° ì§€í‘œì— ë”°ë¼ ë§¤ì¼ íˆ¬ì ë¹„ì¤‘ì„ ë™ì ìœ¼ë¡œ ì¡°ì ˆ\n",
    "\n",
    "4. í•˜ì´í¼íŒŒë¼ë¯¸í„°:\n",
    "   - BUY_Threshold: 0.50 (ê³µê²©ì )\n",
    "   - RSI_Oversold: 30\n",
    "   - Volatility_Filter: ìƒìœ„ 10% ë³€ë™ì„±ë§Œ íšŒí”¼\n",
    "\n",
    "5. ì˜ˆì œì™€ì˜ ì°¨ë³„ì :\n",
    "   - ì˜ˆì œëŠ” ë‹¨ìˆœíˆ í™•ë¥ ë§Œ ë³´ê³  ê±°ë˜í•˜ì§€ë§Œ, ì´ ì „ëµì€ RSIì™€ MACDë¥¼ ê²°í•©í•˜ì—¬ ëª¨ë¸ì´ ë†“ì¹  ìˆ˜ ìˆëŠ” ê¸°ìˆ ì  ë§¤ë§¤ íƒ€ì´ë°ì„ í¬ì°©í•¨\n",
    "   - ê±°ë˜ê°€ ì—†ëŠ”(0 Trades) ìƒí™©ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì§„ì… ì¥ë²½ì„ ë‚®ì¶”ê³  ë³´ì¡° ì§€í‘œë¡œ ë³´ì™„í•˜ëŠ” í•˜ì´ë¸Œë¦¬ë“œ ì „ëµ ì‚¬ìš©\n",
    "```"
]

nb_path = "c:\\AI\\FinalProject\\TimeSeriesForecastingTest\\assignment_notebook.ipynb"

with open(nb_path, "r", encoding="utf-8") as f:
    nb = json.load(f)

modified_count = 0
for cell in nb["cells"]:
    source_str = "".join(cell["source"])
    
    # Replace Simulation Code
    if "# ì˜ˆì¸¡ í•¨ìˆ˜" in source_str and "def predict_with_prob" in source_str:
        # Check if it's the simulation cell we want to replace (contains simulate_custom_strategy)
        # Note: We replaced it before, so look for unique markers or just replacing the Simulation Cell we tagged previously
        if "simulate_custom_strategy" in source_str: 
             print("Found Simulation Cell -> Updating to Aggressive Strategy")
             cell["source"] = CODE_SIM_AGGRESSIVE
             modified_count += 1
    
    # Replace Design Description
    elif "TODO: ì•„ë˜ì— ìì‹ ì˜ ëª¨ë¸ ì„¤ê³„ ì„¤ëª…" in source_str:
        print("Found Design Description -> Updating to Aggressive Description")
        cell["source"] = DESIGN_DESC_AGGRESSIVE
        modified_count += 1

if modified_count >= 2:
    with open(nb_path, "w", encoding="utf-8") as f:
        json.dump(nb, f, indent=1, ensure_ascii=False)
    print(f"Notebook updated with aggressive strategy. Modified bits: {modified_count}")
else:
    print("Warning: Cells not found or already updated.")
